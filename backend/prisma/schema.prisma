// ============================================
// DATABASE SCHEMA - Gym Management System
// ============================================
// 
// This Prisma schema defines all database tables and relationships
// Using SQLite for local, offline-first operation
//
// To generate client: npx prisma generate
// To migrate: npx prisma migrate dev
// To seed: npm run seed

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

/// System users (admin, staff)
model User {
  id        Int      @id @default(autoincrement())
  username  String   @unique
  email     String?  @unique
  password  String   // Hashed with bcrypt
  firstName String
  lastName  String
  role      String   @default("staff") // admin, staff
  permissions String? // JSON array of permission strings for granular RBAC
  avatar    String?  // Profile photo path
  isActive  Boolean  @default(true)
  lastLogin DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  canceledSubscriptions Subscription[] @relation("CanceledSubscriptions")

  // Relations
  activities ActivityLog[]
  openedShifts POSShift[] @relation("ShiftOpener")
  closedShifts POSShift[] @relation("ShiftCloser")
  payments     Payment[]  @relation("PaymentCreator")
  
  // Closing & Audit Relations
  closings        CashClosing[] @relation("EmployeeClosings")
  createdClosings CashClosing[] @relation("CreatedClosings")
  audits          AuditLog[]    @relation("AuditActions")
  refunds         Refund[]
  staffNotifications StaffNotification[]
  cashClosingAdjustments CashClosingAdjustment[]
  cashMovements CashMovement[]
  
  // Sales & Inventory
  stockMovements StockMovement[]
  sales         SaleTransaction[]
  
  // Appointments & Coaching
  appointmentsAsCoach Appointment[] @relation("CoachAppointments")
  commissionSettings  CoachCommissionSettings?
  earnings            CoachEarning[]
  settlements         CoachSettlement[]
  financialRecords    AppointmentFinancialRecord[]
  createdAppointments Appointment[] @relation("AppointmentCreatedBy")
  completedAppointments Appointment[] @relation("AppointmentCompletedBy")
  trainerPayouts      TrainerPayout[] @relation("TrainerPayoutPaidBy")
}

/// Activity log for audit trail
model ActivityLog {
  id          Int      @id @default(autoincrement())
  userId      Int
  action      String   // LOGIN, LOGOUT, CREATE_MEMBER, etc.
  entityType  String?  // Member, Subscription, Payment, etc.
  entityId    Int?
  details     String?  // JSON string with additional details
  ipAddress   String?
  createdAt   DateTime @default(now())

  user User @relation(fields: [userId], references: [id])
}

// ============================================
// MEMBER MANAGEMENT
// ============================================

/// Gym members
model Member {
  id           Int      @id @default(autoincrement())
  memberId     String   @unique // Custom member ID (e.g., GYM-001)
  firstName    String
  lastName     String
  fullName     String?
  displayName  String
  displayNameNorm String
  email        String?
  phone        String
  phoneNorm    String   @unique
  address      String?
  dateOfBirth  DateTime?
  gender       String?  // male, female, other
  photo        String?  // Photo file path
  qrCode       String?  // QR code data/path
  faceEncoding Bytes?   // Face recognition encoding (binary)
  
  // Emergency contact
  emergencyContactName  String?
  emergencyContactPhone String?
  
  // Membership status
  isActive     Boolean  @default(true)
  notes        String?
  lastRenewalDate DateTime?
  
  // Timestamps
  joinDate     DateTime @default(now())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  // Relations
  subscriptions Subscription[]
  checkIns      CheckIn[]
  payments      Payment[]
  reminders     Reminder[]
  appointmentRecords AppointmentFinancialRecord[]
  appointments  Appointment[]

  @@index([gender])
}

// ============================================
// SUBSCRIPTION MANAGEMENT
// ============================================

/// Subscription plans available
model SubscriptionPlan {
  id          Int      @id @default(autoincrement())
  name        String   // Basic, Premium, VIP
  nameAr      String?  // Arabic name
  duration    Int      // Duration in days
  durationType String  @default("days") // days, months, years
  price       Float
  description String?
  descriptionAr String?
  features    String?  // JSON array of features
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  subscriptions Subscription[]
}

/// Member subscriptions
model Subscription {
  id        Int      @id @default(autoincrement())
  memberId  Int
  planId    Int
    startDate DateTime
    endDate   DateTime
    status    String   @default("active") // active, expired, cancelled, frozen
    
    price       Float?  // Snapshot of plan price at subscription creation
    paidAmount  Float?
    remainingAmount Float @default(0)
    paymentStatus String @default("unpaid") // paid, partial, unpaid
  
  usedNonRefundableAmount Float @default(0) // Amount consumed by usage (non-refundable)
  discount    Float    @default(0)
  
  // Freeze functionality
  frozenAt    DateTime?
  frozenUntil DateTime?
  frozenDays  Int?
  
  // Advanced Pause/Resume (New Professional System)
  isPaused    Boolean  @default(false)
  pauseHistory String? // JSON string: [{ start: Date, end: Date, reason: String }]
  
  notes       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Cancellation tracking
  canceledAt    DateTime?
  canceledById  Int?
  canceledBy    User?     @relation("CanceledSubscriptions", fields: [canceledById], references: [id])
  cancelReason  String?
  cancelSource  String?   // manual, auto_refund
  
  // Alerts
  alertAcknowledged Boolean   @default(false)
  alertAcknowledgedAt DateTime?
  alertAcknowledgedBy Int?

  // Relations
  member   Member           @relation(fields: [memberId], references: [id], onDelete: Cascade)
  plan     SubscriptionPlan @relation(fields: [planId], references: [id])
  payments Payment[]
  reminders Reminder[]
}

// ============================================
// CHECK-IN SYSTEM
// ============================================

/// Member check-ins
model CheckIn {
  id           Int       @id @default(autoincrement())
  memberId     Int
  checkInTime  DateTime  @default(now())
  checkOutTime DateTime?
  method       String    @default("manual") // manual, qr, face
  
  // Additional info
  notes        String?
  createdAt    DateTime  @default(now())

  // Relations
  member Member @relation(fields: [memberId], references: [id], onDelete: Cascade)
}

// ============================================
// PAYMENTS & ACCOUNTING
// ============================================

/// Payment records
model Payment {
  id             Int      @id @default(autoincrement())
  memberId       Int
  subscriptionId Int?
  amount         Float
  sessionPrice   Float?
  commissionPercentUsed Float?
  trainerPayout  Float?
  gymShare       Float?
  method         String   @default("cash") // cash, card, transfer
  status         String   @default("completed") // pending, completed, refunded
  
  idempotencyKey String?  @unique
  // Receipt info
  receiptNumber  String   @unique
  notes          String?
  
  // Card/Visa transaction reference
  transactionRef String?  @unique @map("transaction_ref") // Deprecated, use externalReference
  externalReference String? // POS/Bank transaction reference (uniqueness enforced at app level)
  
  // Card Payment Verification (Hybrid System)
  verificationMode  String?  // 'pos_screen' | 'pos_receipt' | 'manual'
  posAmountVerified Float?   // Amount shown on POS device (for audit)
  
  paidAt         DateTime @default(now())
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // POS Info
  shiftId        Int?
  createdBy      Int?     // User ID who processed the payment
  collectorName  String?  // Snapshot of employee name who collected the money
  refundedTotal  Float    @default(0)

  // Relations
  member       Member        @relation(fields: [memberId], references: [id], onDelete: Cascade)
  subscription Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  shift        POSShift?     @relation(fields: [shiftId], references: [id])
  creator      User?         @relation("PaymentCreator", fields: [createdBy], references: [id])
  refunds      Refund[]
  
  earnings     CoachEarning[] // Linked commission earning
    appointmentId Int? @unique
    appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  
  @@index([transactionRef])
}

/// Receipt counters for daily incremental receipt numbers
model ReceiptCounter {
  id         Int      @id @default(autoincrement())
  date       String   @unique // YYYYMMDD
  lastNumber Int      @default(0)
  updatedAt  DateTime @updatedAt
}

/// Unified receipts for payments, subscriptions, and sales
model Receipt {
  id              Int      @id @default(autoincrement())
  receiptNo       String   @unique
  transactionId   String   @unique
  transactionType String
  paymentMethod   String?

  customerId    Int?
  customerName  String?
  customerPhone String?
  customerCode  String?

  staffId   Int?
  staffName String?
  branchName String?

  itemsJson   String // JSON string
  totalsJson  String // JSON string
  status  String   @default("issued") // issued, voided, refunded
  notes   String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([transactionType, createdAt])
  @@index([customerName, customerPhone])
}


/// Expense tracking
model Expense {
  id          Int      @id @default(autoincrement())
  category    String   // rent, utilities, equipment, salaries, etc.
  amount      Float
  description String?
  date        DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  settlement  CoachSettlement?
}

// ============================================
// SETTINGS
// ============================================

/// Application settings (key-value store)
model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String   // Can store JSON for complex values
  type      String   @default("string") // string, number, boolean, json
  group     String   @default("general") // general, branding, pricing, etc.
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================
// NOTIFICATIONS
// ============================================

/// System notifications
model Notification {
  id        Int      @id @default(autoincrement())
  type      String   // subscription_expiry, payment_due, etc.
  title     String
  message   String
  targetId  Int?     // Related entity ID
  isRead    Boolean  @default(false)
  createdAt DateTime @default(now())

}

// ============================================
// POS & SHIFT MANAGEMENT
// ============================================

/// POS Machine (Terminal)
model POSMachine {
  id        Int      @id @default(autoincrement())
  name      String
  machineKey String  @unique // Hash of hardware ID
  status    String   @default("active") // active, inactive
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shifts    POSShift[]
}

/// Work Shift
model POSShift {
  id          Int      @id @default(autoincrement())
  machineId   Int
  openedBy    Int      // User ID
  closedBy    Int?     // User ID
  
  openedAt    DateTime @default(now())
  closedAt    DateTime?
  
  openingCash      Float
  closingCash      Float? // Counted by cashier
  expectedCash     Float? // Calculated system total
  cashDifference   Float? // closing - expected
  
  status      String   @default("open") // open, closed
  activityType String  @default("NORMAL") // NORMAL, NO_ACTIVITY
  notes       String?  // Auto-generated or manual notes
  
  // Relations
  machine     POSMachine @relation(fields: [machineId], references: [id])
  opener      User       @relation("ShiftOpener", fields: [openedBy], references: [id])
  closer      User?      @relation("ShiftCloser", fields: [closedBy], references: [id])
  payments    Payment[]
  refunds     Refund[]
  cashMovements CashMovement[]
  
  // Sales & Inventory
  stockMovements StockMovement[]
  sales          SaleTransaction[]
}

/// Cash Movements (Pay In / Pay Out)
model CashMovement {
  id          Int      @id @default(autoincrement())
  type        String   // IN, OUT
  amount      Float
  reason      String
  notes       String?
  shiftId     Int
  employeeId  Int
  createdAt   DateTime @default(now())
  
  shift       POSShift @relation(fields: [shiftId], references: [id])
  employee    User     @relation(fields: [employeeId], references: [id])
}

// ============================================
// CASH CLOSING & AUDIT
// ============================================

/// Cash Closing (Reconciliation) Records
model CashClosing {
  id                    Int      @id @default(autoincrement())
  employeeId            Int?     // Optional: filtering by employee
  employeeName          String?  // Snapshot name
  
  periodType            String   // daily, monthly, custom
  startAt               DateTime
  endAt                 DateTime
  
  // Snapshots (Expected)
  expectedCashAmount    Float    @default(0)
  expectedNonCashAmount Float    @default(0)
  expectedTotalAmount   Float    @default(0)
  
  // Declared (Input)
  declaredCashAmount    Float    @default(0)
  declaredNonCashAmount Float    @default(0)
  declaredTotalAmount   Float    @default(0)
  
  // Difference
  differenceCash        Float    @default(0)
  differenceNonCash     Float    @default(0)
  differenceTotal       Float    @default(0)

  // Financial Snapshot (Immutable Report)
  totalSessions         Int      @default(0)
  grossRevenue          Float    @default(0)
  totalCoachCommissions Float    @default(0)
  gymNetIncome          Float    @default(0)
  
  breakdownByCoach      String?  // JSON string
  breakdownByService    String?  // JSON string
  
  status                String   // shortage, overage, balanced
  notes                 String?
  
  createdBy             Int
  createdAt             DateTime @default(now())

  // Relations
  employee  User? @relation("EmployeeClosings", fields: [employeeId], references: [id])
  creator   User  @relation("CreatedClosings", fields: [createdBy], references: [id])
  adjustments CashClosingAdjustment[]
}

/// Post-closing manual adjustments
model CashClosingAdjustment {
  id          Int      @id @default(autoincrement())
  closingId   Int
  type        String   // ADD, SUBTRACT
  amount      Float
  reason      String
  createdBy   Int
  createdAt   DateTime @default(now())

  closing     CashClosing @relation(fields: [closingId], references: [id])
  creator     User        @relation(fields: [createdBy], references: [id])
}

/// System Audit Logs
model AuditLog {
  id          Int      @id @default(autoincrement())
  action      String   // e.g., CASH_CLOSING_CREATED
  entityType  String   // e.g., CashClosing
  entityId    String?  // Store as string to support mixed ID types if needed
  performedBy Int
  timestamp   DateTime @default(now())
  metadata    String?  // JSON string
  
  user        User     @relation("AuditActions", fields: [performedBy], references: [id])
}

/// Refund Records
model Refund {
  id          Int      @id @default(autoincrement())
  paymentId   Int
  amount      Float
  reason      String?
  shiftId     Int
  createdBy   Int
  createdAt   DateTime @default(now())
  
  // Relations
  payment     Payment   @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  shift       POSShift  @relation(fields: [shiftId], references: [id])
  user        User      @relation(fields: [createdBy], references: [id])
}

// ============================================
// PAYMENT REMINDERS & STAFF NOTIFICATIONS
// ============================================

/// Payment reminders for members with outstanding balances
model Reminder {
  id             Int       @id @default(autoincrement())
  memberId       Int
  subscriptionId Int?
  type           String    // DUE_SOON, OVERDUE, END_OF_MONTH, INSTALLMENT
  channel        String    @default("IN_APP") // SMS, WHATSAPP, EMAIL, IN_APP
  scheduledAt    DateTime
  sentAt         DateTime?
  status         String    @default("PENDING") // PENDING, SENT, FAILED, CANCELLED
  message        String?   // Generated message content
  retryCount     Int       @default(0)
  
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  
  // Relations
  member         Member       @relation(fields: [memberId], references: [id], onDelete: Cascade)
  subscription   Subscription? @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  notifications  StaffNotification[]
  
  @@index([memberId])
  @@index([status])
  @@index([scheduledAt])
}

/// Staff notifications for payment alerts
model StaffNotification {
  id          Int       @id @default(autoincrement())
  userId      Int
  reminderId  Int?
  type        String    // PAYMENT_DUE, PAYMENT_OVERDUE, SYSTEM
  title       String
  message     String
  priority    String    @default("NORMAL") // LOW, NORMAL, HIGH
  seenAt      DateTime?
  createdAt   DateTime  @default(now())
  
  // Relations
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  reminder    Reminder? @relation(fields: [reminderId], references: [id], onDelete: SetNull)
  
  @@index([userId, seenAt])
}

/// Trainers (staff) available for sessions
model StaffTrainer {
  id                Int      @id @default(autoincrement())
  name              String
  phone             String?
    commissionPercent Float?
  commissionType    String   @default("percentage") // percentage, fixed
  commissionValue   Float?
  internalSessionValue Float @default(0)
  active            Boolean  @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  appointments      Appointment[]
  earnings          TrainerEarning[]
  payouts           TrainerPayout[]
}

model TrainerPayout {
  id                Int      @id @default(autoincrement())
  trainerId         Int
  totalAmount       Float
  method            String   // CASH, TRANSFER
  note              String?
  paidAt            DateTime @default(now())
  paidByEmployeeId  Int?
  createdAt         DateTime @default(now())

  trainer           StaffTrainer @relation(fields: [trainerId], references: [id])
  paidByEmployee    User?        @relation("TrainerPayoutPaidBy", fields: [paidByEmployeeId], references: [id])
  earnings          TrainerEarning[]

  @@index([trainerId])
}

model TrainerEarning {
  id                Int      @id @default(autoincrement())
  trainerId         Int
  appointmentId     Int      @unique
  baseAmount        Float    @default(0)
  commissionPercent Float?
  commissionAmount  Float    @default(0)
  status            String   @default("UNPAID") // UNPAID, PAID
  payoutId          Int?
  createdAt         DateTime @default(now())

  trainer           StaffTrainer @relation(fields: [trainerId], references: [id])
  appointment       Appointment  @relation(fields: [appointmentId], references: [id])
  payout            TrainerPayout? @relation(fields: [payoutId], references: [id])

  @@index([trainerId, status])
}

// ============================================
// SALES & INVENTORY
// ============================================

/// Products for sale
model Product {
  id          Int      @id @default(autoincrement())
  name        String
  description String?
  salePrice   Float
  imageUrl    String?
  sku         String?  @unique // Barcode/SKU
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  stockMovements StockMovement[]
  saleItems      SaleItem[]
}

/// Inventory Audit Log
model StockMovement {
  id          Int      @id @default(autoincrement())
  productId   Int
  type        String   // IN, OUT, ADJUST
  quantity    Int      // Absolute value
  unitCost    Float?   // Optional: Cost price for IN movements
  reason      String?  // Required for ADJUST
  notes       String?
  
  shiftId     Int?     // Optional: inventory changes might happen during a shift
  employeeId  Int      // Who performed the action
  createdAt   DateTime @default(now())

  product     Product  @relation(fields: [productId], references: [id])
  employee    User     @relation(fields: [employeeId], references: [id])
  shift       POSShift? @relation(fields: [shiftId], references: [id])
}

/// Point of Sale Transaction
model SaleTransaction {
  id            Int      @id @default(autoincrement())
  shiftId       Int      // Must be linked to an open shift
  employeeId    Int      // Cashier
  paymentMethod String   // cash, card, transfer
  totalAmount   Float
  notes         String?
  createdAt     DateTime @default(now())

  shift     POSShift   @relation(fields: [shiftId], references: [id])
  employee  User       @relation(fields: [employeeId], references: [id])
  items     SaleItem[]
}

/// Line items for a sale
model SaleItem {
  id                Int      @id @default(autoincrement())
  saleTransactionId Int
  productId         Int
  quantity          Int
  unitPrice         Float    // Price at time of sale (snapshot)
  lineTotal         Float
  
  transaction SaleTransaction @relation(fields: [saleTransactionId], references: [id], onDelete: Cascade)
  product     Product         @relation(fields: [productId], references: [id])
}

// ============================================
// SERVICE CONFIGURATION
// ============================================

/// Configurable Services (Session Types)
model Service {
  id              Int      @id @default(autoincrement())
  name            String
  type            String   @default("SESSION") // SESSION, SUBSCRIPTION
  defaultPrice    Float    @default(0)
  defaultDuration Int      @default(60) // minutes
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
}

// ============================================
// APPOINTMENTS & COACHING
// ============================================

/// Personal Training / Service Appointments
model Appointment {
  id          Int      @id @default(autoincrement())
  title       String?  // e.g. "PT Session"
  memberId    Int
  coachId     Int
  
  start       DateTime
  end         DateTime
  price       Float    @default(0)   // Base price at booking
  finalPrice  Float?                // Final price after adjustments; fallback to price when null
  paidAmount  Float    @default(0)
  dueAmount   Float    @default(0)
  overpaidAmount Float @default(0)
  paymentStatus String @default("unpaid") // unpaid, partial, paid, due, overpaid
  
  status      String   @default("scheduled") // scheduled, completed, cancelled, no_show
  notes       String?

  createdByEmployeeId   Int?
  completedByEmployeeId Int?
  completedAt           DateTime?
  isCompleted           Boolean  @default(false)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  member      Member   @relation(fields: [memberId], references: [id])
    coach       User     @relation("CoachAppointments", fields: [coachId], references: [id])
  createdByEmployee   User? @relation("AppointmentCreatedBy", fields: [createdByEmployeeId], references: [id])
  completedByEmployee User? @relation("AppointmentCompletedBy", fields: [completedByEmployeeId], references: [id])
  
    trainerId   Int?
  trainer     StaffTrainer? @relation(fields: [trainerId], references: [id])
  payments    Payment[]
  earnings    CoachEarning[]
  financialRecord AppointmentFinancialRecord?
  trainerEarning TrainerEarning?
  priceAdjustments SessionPriceAdjustment[]
}

/// Commission configuration per coach
model CoachCommissionSettings {
  id                  Int      @id @default(autoincrement())
  coachId             Int      @unique
  type                String   @default("percentage") // percentage, fixed
  value               Float    // e.g. 10.0 (10%) or 50.0 (fixed currency)
  internalSessionValue Float   @default(0) // Default value for session if percentage
  
  coach       User     @relation(fields: [coachId], references: [id])
}

// ============================================
// FINANCIAL RECORDS (SINGLE SOURCE OF TRUTH)
// ============================================

/// Immutable record created upon appointment completion
model AppointmentFinancialRecord {
  id              Int      @id @default(autoincrement())
  
  // Source
  appointmentId   Int      @unique
  memberId        Int
  coachId         Int
  
  // Financials
  sessionPrice    Float    // Gross Revenue
  coachCommission Float    // Deducted Commission
  gymNetIncome    Float    // Net Profit for Gym
  
  // Metadata
  commissionType  String?  // 'percentage' or 'fixed'
  commissionValue Float?   // The % or fixed amount used
  basisAmount     Float?   // The amount commission was calculated on
  
  // Status
  status          String   @default("PENDING") // PENDING (for coach payout) -> PAID
  
  // Timestamps
  completedAt     DateTime // When the session was marked complete
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  appointment     Appointment @relation(fields: [appointmentId], references: [id])
  member          Member      @relation(fields: [memberId], references: [id])
  coach           User        @relation(fields: [coachId], references: [id])
  
  // Optional link to settlement if paid out
  settlementId    Int?
  settlement      CoachSettlement? @relation(fields: [settlementId], references: [id])
}

/// Ledger of coach earnings (commissions) - LEGACY SUPPORT / MAPPED TO FINANCIAL RECORD
model CoachEarning {
  id                  Int      @id @default(autoincrement())
  coachId             Int
  memberId            Int?     // Snapshot of member for easier reporting
  appointmentId       Int?     @unique // Source - Unique to prevent duplicates
  paymentId           Int?     // Trigger (Optional, legacy)
  
  amount              Float    // Calculated Commission amount
  basisAmount         Float    // Value used for calc (internal or price)
  
  // Snapshots for audit
  commissionType      String?
  commissionValue     Float?
  internalSessionValue Float?

  status              String   @default("pending") // pending, paid
  notes               String?
  paidAt              DateTime?
  paidByUserId        Int?
  
  settlementId        Int?
  
  createdAt           DateTime @default(now())
  
  // Relations
  coach         User        @relation(fields: [coachId], references: [id])
  appointment   Appointment? @relation(fields: [appointmentId], references: [id])
  payment       Payment?     @relation(fields: [paymentId], references: [id])
  settlement    CoachSettlement? @relation(fields: [settlementId], references: [id])
}

/// Payout batches
model CoachSettlement {
  id          Int      @id @default(autoincrement())
  coachId     Int
  totalAmount Float
  startDate   DateTime // Period start
  endDate     DateTime // Period end
  status      String   @default("completed")
  
  expenseId   Int?     @unique
  
  createdAt   DateTime @default(now())
  
  // Relations
  coach       User     @relation(fields: [coachId], references: [id])
  expense     Expense? @relation(fields: [expenseId], references: [id])
  earnings    CoachEarning[]
  financialRecords AppointmentFinancialRecord[]
}

model SessionPriceAdjustment {
  id              Int      @id @default(autoincrement())
  appointmentId   Int
  oldFinalPrice   Float
  newFinalPrice   Float
  delta           Float
  reason          String
  changedByUserId Int?
  createdAt       DateTime @default(now())

  appointment Appointment @relation(fields: [appointmentId], references: [id])
  changedBy   User?       @relation(fields: [changedByUserId], references: [id])
}

